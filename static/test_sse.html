<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ë‰´ìŠ¤ í…ŒìŠ¤íŠ¸</title>
    <style>
        body { font-family: 'Pretendard', sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        h1 { border-bottom: 2px solid #333; padding-bottom: 10px; }
        .card { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 8px; }
        .btn { padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px; }
        .btn:hover { background: #0056b3; }
        .log { background: #f4f4f4; padding: 10px; border-radius: 4px; margin-top: 10px; white-space: pre-wrap; font-family: monospace; max-height: 300px; overflow-y: auto; }
        .debate-section { margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px; }
    </style>
</head>
<body>
    <h1>ğŸ—ï¸ AI ë‰´ìŠ¤ & í† ë¡  í…ŒìŠ¤íŠ¸</h1>

    <div class="card">
        <h3>1. í† í”½ ëª©ë¡ ì¡°íšŒ</h3>
        <button class="btn" onclick="fetchTopics()">í† í”½ ê°€ì ¸ì˜¤ê¸°</button>
        <div id="topicList" style="margin-top: 10px;"></div>
    </div>

    <div class="card" id="detailCard" style="display:none;">
        <h3>2. í† í”½ ìƒì„¸ & í† ë¡ </h3>
        <div id="topicDetail"></div>
        
        <div class="debate-section">
            <h4>ğŸ¤– AI ì‹¤ì‹œê°„ í† ë¡ </h4>
            <button class="btn" onclick="startDebateSSE()">í† ë¡  ìƒì„±/ë³´ê¸° (SSE)</button>
            <div id="debateStatus" style="margin-top: 10px; font-weight: bold; color: #666;"></div>
            <div id="debateLog" class="log"></div>
        </div>
    </div>

    <script>
        let currentTopicId = null;
        const API_BASE = 'http://127.0.0.1:8000';

        async function fetchTopics() {
            try {
                const res = await fetch(`${API_BASE}/topics`);
                const topics = await res.json();
                
                const html = topics.map(t => `
                    <div style="padding: 10px; border-bottom: 1px solid #eee;">
                        <strong>[ID: ${t.topic_id}]</strong> ${t.ai_neutral_headline || 'ì œëª© ì—†ìŒ'} 
                        <button class="btn" style="padding: 2px 8px; font-size: 12px;" onclick="viewTopic(${t.topic_id})">ì„ íƒ</button>
                    </div>
                `).join('');
                document.getElementById('topicList').innerHTML = html;
            } catch (e) {
                alert('API í˜¸ì¶œ ì‹¤íŒ¨: ' + e);
            }
        }

        async function viewTopic(id) {
            currentTopicId = id;
            document.getElementById('detailCard').style.display = 'block';
            document.getElementById('debateLog').textContent = '';
            document.getElementById('debateStatus').textContent = '';
            
            try {
                const res = await fetch(`${API_BASE}/topics/${id}`);
                const data = await res.json();
                document.getElementById('topicDetail').innerHTML = `
                    <h4>${data.ai_neutral_headline}</h4>
                    <p>${data.ai_core_summary}</p>
                    <hr>
                    <div><strong>ëŒ€í‘œ ê¸°ì‚¬:</strong> ${data.article ? data.article.original_title : 'ì—†ìŒ'}</div>
                `;
            } catch (e) {
                alert('ìƒì„¸ ì¡°íšŒ ì‹¤íŒ¨: ' + e);
            }
        }

        function startDebateSSE() {
            if (!currentTopicId) return;
            
            const logDiv = document.getElementById('debateLog');
            const statusDiv = document.getElementById('debateStatus');
            logDiv.textContent = 'ì—°ê²° ì¤‘...';
            
            // SSE ì—°ê²°
            const evtSource = new EventSource(`${API_BASE}/debate/${currentTopicId}/sse`);

            evtSource.onopen = () => {
                statusDiv.textContent = 'ğŸŸ¢ ì—°ê²°ë¨';
            };

            evtSource.addEventListener("status", (e) => {
                if (e.data === "generating") {
                    statusDiv.textContent = 'ğŸŸ¡ AIê°€ ì—´ì‹¬íˆ í† ë¡ ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤... (ì•½ 10-20ì´ˆ ì†Œìš”)';
                    logDiv.textContent = 'ìƒì„± ì¤‘...';
                }
            });

            evtSource.addEventListener("complete", (e) => {
                statusDiv.textContent = 'âœ… í† ë¡  ìƒì„± ì™„ë£Œ!';
                const data = JSON.parse(e.data);
                renderDebate(data);
                evtSource.close();
            });

            evtSource.addEventListener("error", (e) => {
                // ì—°ê²° ì¢…ë£Œ ì‹œ ì—ëŸ¬ ì´ë²¤íŠ¸ê°€ ë°œìƒí•  ìˆ˜ ìˆìŒ (ì •ìƒ ì¢…ë£Œ í¬í•¨)
                if (evtSource.readyState === EventSource.CLOSED) {
                    statusDiv.textContent = 'ğŸ”´ ì—°ê²° ì¢…ë£Œ';
                } else {
                    statusDiv.textContent = 'âŒ ì—ëŸ¬ ë°œìƒ: ' + e.data;
                    evtSource.close();
                }
            });
        }

        function renderDebate(data) {
            const logDiv = document.getElementById('debateLog');
            let html = '';
            
            // ì°¸ê°€ì ì†Œê°œ
            html += `[ì‚¬íšŒì] ì˜¤ëŠ˜ì˜ í† ë¡  ì£¼ì œëŠ” "${data.topic_headline}" ì…ë‹ˆë‹¤.\n\n`;
            
            // ë¼ìš´ë“œë³„ ë°œì–¸
            data.rounds.forEach(round => {
                html += `=== Round ${round.round_number}: ${round.theme} ===\n`;
                round.statements.forEach(stmt => {
                    const debater = data.debaters[stmt.speaker];
                    html += `[${debater.name}]: ${stmt.content}\n\n`;
                });
            });

            // ê²°ë¡ 
            html += `=== ê²°ë¡  ===\n${data.conclusion.summary}\n\n`;
            html += `ì¶”ì²œ: ${data.conclusion.recommendation}`;
            
            logDiv.textContent = html;
        }
    </script>
</body>
</html>
